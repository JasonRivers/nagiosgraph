$Id$
------------------------       License: OSI Artistic License
nagiosgraph Installation       Author:  (c) 2005 Soren Dossing
------------------------       Author:  (c) 2008 Alan Brenner, Ithaka Harbors
                               Author:  (c) 2010 Matthew Wall

These are the installation and configuration instructions for nagiosgraph.
This document contains the following sections:

  Installation Preliminaries
  Installation Instructions
  Upgrade Notes
  Configuring Data Processing
    Old Style
    New Style
  Configuring Graphing and Display
    Displaying Per-Service and Per-Host Graph Icons in Nagios
    Displaying Graphs in Nagios Mouseovers
    Displaying Graphs in Nagios Frames
  Customizing the Graphs
  Adding Services
  Appendix: Sample Installation Layouts
  Appendix: Web Server Configuration
  Appendix: Platform Specific Notes
    CentOS 5 and Nagiosgraph 0.9:
    Fedora Core 6, Nagios 2.6+, and HTTP output parsing

The instructions below are mainly for Nagios 2.x and 3.x and might differ
in other versions of Nagios.

See Principles of Operation in the README file for an overview of how
Nagiosgraph is designed to work.


Installation Preliminaries
--------------------------

  Nagiosgraph will not function without a working Nagios installation, so
  first ensure that Nagios works.

  Nagiosgraph depends on perfdata processing in Nagios using the Nagios
  directive process_performance_data.

  Nagiosgraph uses rrdtool from perl, so both rrdtool and the perl wrapper
  for rrdtool must be installed.

  There are two installation layouts for Nagiosgraph: separate or overlay.
  The separated layout has nagiosgraph and nagios in separate directories.
  The overlay places nagiosgraph components with nagios components.
  Note also that nagios and nagiosgraph can be installed in just about
  any location, for example /opt or /usr/local.  So decide upon a layout
  before you start the installation.

  Examples of these layouts are in the Sample Installation Layouts section.


Installation Instructions
-------------------------

 - Check required packages: nagios, nagios-plugins, rrdtool, perl,
   perl-CGI, and perl-rrdtool

 - Extract the Nagiosgraph tarball into a temporary location:
     cd /tmp
     tar xzvf nagiosgraph-x.y.z.tgz

 - Copy the contents of etc into your preferred configuration location,
   e.g. /etc/nagiosgraph

 - Edit the perl scripts in the cgi and lib directories, modifying the
   "use lib" line to point to the directory from the previous step.

 - Copy the contents of lib into a location Nagios can execute files,
   e.g. /usr/lib/nagios/libexec

 - Copy the contents of cgi into the Nagios cgi-bin directory,
   e.g. /usr/lib/nagios/cgi-bin

 - Copy the share/action.gif file into the Nagios image directory,
   e.g. /usr/share/nagios/images

 - Copy the share/nagiosgraph.css file into the Nagios stylesheets directory,
   e.g. /usr/share/nagios/stylesheets

 - Copy the share/nagiosgraph.js file into a directory served by the web server
   e.g. /usr/share/nagiosgraph

 - Edit nagiosgraph.conf.  Set at least the following:

     logfile
     perflog
     rrddir
     mapfile
     nagiosgraphcgiurl
     javascript
     stylesheet

 - Set permissions of "rrddir" (as defined in nagiosgraph.conf) so that
   the *nagios* user can write to it and the *www* user can read it.

 - Set permissions of "logfile" (as defined in nagiosgraph.conf) so that
   both the *nagios* and *www* users can write to "logfile".


Upgrade Notes
-------------

 - Follow the steps above, but keep your customizations.  Your changes should
   be limited to the configuration files (map, nagiosgraph.conf, servdb.conf,
   hostdb.conf, groupdb.conf, datasetdb.conf, rrdopts.conf).  You may also
   have modifications to the stylesheet (nagiosgraph.css).

 - Use diff, or a similar tool, to update your nagiosgraph.conf with any new
   fields from etc/nagiosgraph.conf and the stylesheet.

 - You may want to look at etc/map to see if there are any new examples that
   you may find useful.


Configuring Data Processing
---------------------------

Before nagiosgraph can graph anything it must first collect data.  There are
two ways to process data - the new style and the old style.  The old style
typically requires more CPU.

In the new style, performance data are appended to a file, then nagios invokes
insert.pl at a regular interval to update the rrd files.

In the old style, nagios invokes insert.pl immediately after each service
check, thus updating the corresponding rrd files.


New Style Processing
--------------------

 - In nagios.cfg set:

     process_performance_data=1
     service_perfdata_file=/var/spool/nagios/perfdata.log
     service_perfdata_file_template=$LASTSERVICECHECK$||$HOSTNAME$||$SERVICEDESC$||$SERVICEOUTPUT$||$SERVICEPERFDATA$
     service_perfdata_file_mode=a
     service_perfdata_file_processing_interval=30
     service_perfdata_file_processing_command=process-service-perfdata

   Make sure that service_perfdata_command is either commented out
   or not defined.

   Make sure that location of service_perfdata_file matches that of perflog
   defined in nagiosgraph.conf.

 - In checkcommands.cfg or misccommands.cfg, depending on which is
   defined in nagios.cfg:

     define command {
       command_name  process-service-perfdata
       command_line  /usr/local/nagios/nagiosgraph/insert.pl
     }

   Make sure there is only one definition for process-service-perfdata.

   Some installations of Nagios (e.g. with embedded perl) require the explicit
   location of perl.  For these installations, use a command_line such as:

     command_line /usr/bin/perl /etc/nagios/nagiosgraph/insert.pl


Old Style Processing
--------------------

 - In nagios.cfg:

     process_performance_data=1
     service_perfdata_command=process-service-perfdata

   Make sure that service_perfdata_file_processing_command is either
   commented out or not defined.

 - In checkcommands.cfg or misccommands.cfg, depending on which one is
   defined in nagios.cfg:

     define command{
       command_name  process-service-perfdata
       command_line  /usr/local/nagios/nagiosgraph/insert.pl "$LASTSERVICECHECK$||$HOSTNAME$||$SERVICEDESC$||$SERVICEOUTPUT$||$SERVICEPERFDATA$"
     }

   Some installations of Nagios (e.g. with embedded perl) require the explicit
   location of perl.  For these installations, use a command_line such as:

     command_line /usr/bin/perl /etc/nagios/nagiosgraph/insert.pl "$LASTSERVICECHECK$||$HOSTNAME$||$SERVICEDESC$||$SERVICEOUTPUT$||$SERVICEPERFDATA$"



Configuring Graphing and Display
--------------------------------

First configure the web server to run the nagiosgraph CGI scripts.  For
example, with Apache do something like this in the Apache configuration:

  ScriptAlias /nagiosgraph/cgi-bin /usr/lib/nagiosgraph/cgi-bin
  <Directory "/usr/lib/nagiosgraph/cgi-bin">
     Options ExecCGI
     AllowOverride None
     Order allow,deny
     Allow from all
  </Directory>

Verify that nagiosgraph is working by running show.cgi or showhost.cgi.

  http://server/nagiosgraph/cgi-bin/show.cgi

After the CGI scripts are running you can configure nagios.  There are
a few ways to embed nagiosgraph into nagios.  Nagios will display graph
icons that, when clicked, will open a new web page displaying nagiosgraph
graphs.  These icons can be displayed per-host (linked to the showhost.cgi
script) or per-host-service (linked to the show.cgi script).  Nagios will
display graph data when the mouse is moved over host/service action icons.
And graphs can be displayed directly in the Nagios frames.



Displaying Per-Service and Per-Host Graph Icons and Links in Nagios
-------------------------------------------------------------------

Links to graphs can be embedded in Nagios status pages using the notes or
actions fields.  The specifics depend on the Nagios version as well as how
you have configured your host and service definitions.  Nagios 2 uses the
serviceextinfo and hostextinfo construct.  In Nagios 3 the nagiosgraph
additions go directly in the host and service definitions.

 - For Nagios 2.6 and earlier,

     If you have these lines in nagios.cfg, un-comment the 2 cfg_file= lines:

     # Extended host/service info definitions are now stored along with
     # other object definitions:
     # cfg_file=/etc/nagios/hostextinfo.cfg
     # cfg_file=/etc/nagios/serviceextinfo.cfg

     Otherwise, define in cgi.cfg the following:

     xedtemplate_config_file=/usr/local/etc/nagios/serviceextinfo.cfg

   Edit/Create hostextinfo.cfg

     define hostextinfo {
       host_name  your-host
       action_url /nagiosgraph/showhost.cgi?host=$HOSTNAME$
     }

     This must be the host you will use in serviceextinfo.cfg

   Edit/Create serviceextinfo.cfg

     define serviceextinfo {
       service_description  DNS
       hostgroup       servers
       notes_url       /nagiosgraph/show.cgi?host=$HOSTNAME$&service=$SERVICEDESC$
       icon_image      graph.gif
       icon_image_alt  View graphs
     }

 - For Nagios 2.9 and Nagios 3, use the action_url for any existing host
   or service definition.  For example,

     define service {
       name NTP
       use local-service
       action_url /nagiosgraph/show.cgi?host=$HOSTNAME$&service=$SERVICEDESC$
     }

   Optionally replace nagios/images/action.gif with graph.gif from the
   nagiosgraph distribution.



Displaying Graphs in Nagios Mouseovers
--------------------------------------

To display graphs as mouseovers for each host and/or service, do the following:

  - Edit the file share/nagiosgraph.ssi to contain the correct URL to
    nagiosgraph.js (e.g. /nagiosgraph/nagiosgraph.js)

  - If you have not customized the Nagios SSI, copy share/nagiosgraph.ssi to
    the nagios ssi directory, and rename it so that Nagios will insert it into
    each page.  For example:

      cp share/nagiosgraph.ssi /usr/share/nagios/ssi/common-header.ssi

    If you have customized Nagios SSI, add the contents of
    share/nagiosgraph.ssi to your customized SSI header file(s).

  - Configure services to display graphs on mouseovers by adding some 
    JavaScript to action_url or notes_url.  For example:

     define service {
       name NTP
       use local-service
       action_url /nagiosgraph/show.cgi?host=$HOSTNAME$&service=$SERVICEDESC$' onMouseOver='showGraphPopup(this)' onMouseOut='hideGraphPopup()' rel='/nagiosgraph/showgraph.cgi?host=$HOSTNAME$&service=$SERVICEDESC$
     }

    This example displays only the graph data, in a smaller popup:

     define service {
       name NTP
       use local-service
       action_url /nagiosgraph/show.cgi?host=$HOSTNAME$&service=$SERVICEDESC$' onMouseOver='showGraphPopup(this)' onMouseOut='hideGraphPopup()' rel='/nagiosgraph/showgraph.cgi?host=$HOSTNAME$&service=$SERVICEDESC$&rrdopts=-w+450-j
     }

    Similar to previous example, but a week of data rather than a day:

     define service {
       name NTP
       use local-service
       action_url /nagiosgraph/show.cgi?host=$HOSTNAME$&service=$SERVICEDESC$' onMouseOver='showGraphPopup(this)' onMouseOut='hideGraphPopup()' rel='/nagiosgraph/showgraph.cgi?host=$HOSTNAME$&service=$SERVICEDESC$&period=week&rrdopts=-w+450-j
     }

You must restart Nagios for changes to service/host defintions to take effect.

If a service includes multiple data sets, use the datasetdb file (specified
in nagiosgraph.conf) to indicate which data sets should be displayed by
default for each service, or specify the data set(s) explicity in each
action_url.



Displaying Graphs in Nagios Frames
----------------------------------

To embed nagiosgraph graphs directly into nagios, do the following:

  - Modify side.php (e.g. /opt/nagios/share/side.php) by inserting
    bullets under the 'Trends' heading:

<li><a href="<?php echo $cfg["cgi_base_url"];?>/trends.cgi" target="<?php echo $link_target;?>">Trends</a>
<ul>
<li><a href="<?php echo $cfg["cgi_base_url"];?>/show.cgi" target="<?php echo $link_target;?>">Graphs</a></li>
<li><a href="<?php echo $cfg["cgi_base_url"];?>/showhost.cgi" target="<?php echo $link_target;?>">Graphs by Host</a></li>
<li><a href="<?php echo $cfg["cgi_base_url"];?>/showservice.cgi" target="<?php echo $link_target;?>">Graphs by Service</a></li>
<li><a href="<?php echo $cfg["cgi_base_url"];?>/showgroup.cgi" target="<?php echo $link_target;?>">Graphs by Group</a></li>
</ul>
</li>

  - If you keep the nagiosgraph cgi scripts in a location different than
    the nagios cgi scripts, then use 'ng_cgi_base_url' rather than
    'cgi_base_url' and make an entry in config.inc.php such as this:

$cfg['cgi_base_url']='/nagios/cgi-bin';
$cfg['ng_cgi_base_url']='/nagiosgraph/cgi-bin';



Customizing the Graphs
----------------------

Graphs can be customized individually by specifying CGI arguments, or they
can be customized overall by specifying values in the nagiosgraph.conf or
rrdopts.conf files.  Here are a few examples of what is possible.

 -- Add geom option (e.g. &geom=350x100) for custom sizes of graphs.

 -- Add rrdopts option (e.g. &rrdopts=%2Dl%200%20%2Du%20100 (meaning:
    "-l 0 -u 100")) for custom Y axis ranges. Any rrdgraph options can
    be specified, but has to be url encoded.

 -- Add &fixedscale to set the Y-axis to be in the same scale as the
    perf data.  This will also set the legends to be in same scale.

 -- Add hidelegend (e.g. &hidelegend) to hide the legend.

 -- Use lineformat to control the line thickness and line color for
    different services.

 -- Create stacked area graphs using alpha channel in colors specified
    in the lineformat directive for each data set or in rrdopts.conf 
    for specific services and data sets.

 -- Use plotasX to control the line thickness for different services.

 -- Some type of services have data values that have big differences in the
    magnitude. In such cases split the data into seperate graphs. Do this by
    specifying one or more data sets.  For example, for the NTP service:

    show.cgi?host=HOST&service=NTP&db=ntp,jitter,offset
    show.cgi?host=HOST&service=NTP&db=ntp,stratum

See the nagiosgraph.conf file for more options and examples.



Adding Services
---------------

To add new service types, edit the map file. This contains regular
expression to identify service types, and defines how to store data in
rrd files.

 - Use testentry.pl for testing before inserting in map file.

 - You can run the nagios check command from the command line to see
   what is returned.

 - Changes to the map file generally do not require a restart of Nagios.

 - Increase debug level in nagiosgraph.conf to see what is happening.
   Output will go to the nagiosgraph log file.

 - Keep an eye on the log file. It can grow big. Perhaps rotate it, or
   decrease log level when everything works.

The README.map file contains details for defining and testing new mappings.



Sample Installation Layouts
---------------------------

Here are samples of nagiosgraph/nagios installation layouts.

  separate, installed to /opt:
    /opt/nagios/bin/
    /opt/nagios/cgi-bin/
    /opt/nagios/etc/
    /opt/nagios/include/
    /opt/nagios/libexec/
    /opt/nagios/perl/
    /opt/nagios/sbin/
    /opt/nagios/share/

    /opt/nagiosgraph/bin/insert.pl
    /opt/nagiosgraph/cgi-bin/show.cgi
    /opt/nagiosgraph/cgi-bin/showhost.cgi
    /opt/nagiosgraph/cgi-bin/showservice.cgi
    /opt/nagiosgraph/cgi-bin/showgraph.cgi
    /opt/nagiosgraph/etc/ngshared.pm
    /opt/nagiosgraph/etc/nagiosgraph.conf
    /opt/nagiosgraph/share/nagiosgraph.css
    /opt/nagiosgraph/share/nagiosgraph.js
   
  overlay, installed to /:
    /usr/lib/nagios/libexec/insert.pl
    /usr/lib/nagios/cgi-bin/show.cgi
    /usr/lib/nagios/cgi-bin/showhost.cgi
    /usr/lib/nagios/cgi-bin/showservice.cgi
    /usr/lib/nagios/cgi-bin/showgraph.cgi
    /etc/nagiosgraph/ngshared.pm
    /etc/nagiosgraph/nagiosgraph.conf
    /usr/share/nagios/stylesheets/nagiosgraph.css
    /usr/share/nagios/nagiosgraph.js

  overlay, installed to /usr/local:
    /usr/local/nagios/libexec/insert.pl
    /usr/local/nagios/cgi-bin/show.cgi
    /usr/local/nagios/cgi-bin/showhost.cgi
    /usr/local/nagios/cgi-bin/showservice.cgi
    /usr/local/nagios/cgi-bin/showgraph.cgi
    /usr/local/nagios/etc/ngshared.pm
    /usr/local/nagios/etc/nagiosgraph.conf
    /usr/local/nagios/share/stylesheets/nagiosgraph.css
    /usr/local/nagios/share/nagiosgraph.js



Web Server Configuration
------------------------

Here are snippets from a typical (but basic) Apache server configuration.

ScriptAlias /nagiosgraph/cgi-bin/ "/opt/nagiosgraph/cgi/"
<Directory "/opt/nagiosgraph/cgi">
   Options ExecCGI
   AllowOverride None
   Order allow,deny
   Allow from all
</Directory>

Alias /nagiosgraph "/opt/nagiosgraph/share"
<Directory "/opt/nagiosgraph/share">
   Options None
   AllowOverride None
   Order allow,deny
   Allow from all
</Directory>

ScriptAlias /nagios/cgi-bin "/opt/nagios/sbin"
<Directory "/opt/nagios/sbin">
   Options ExecCGI
   AllowOverride None
   Order allow,deny
   Allow from all
</Directory>

Alias /nagios "/opt/nagios/share"
<Directory "/opt/nagios/share">
   Options None
   AllowOverride None
   Order allow,deny
   Allow from all
</Directory>



Platform Specific Notes
-----------------------

CentOS 5 and Nagiosgraph 0.9:
-----------------------------

  wget 'http://dag.wieers.com/rpm/packages/rrdtool/rrdtool-1.2.18-1.el5.rf.i386.rpm'
  wget 'http://dag.wieers.com/rpm/packages/rrdtool/perl-rrdtool-1.2.18-1.el5.rf.i386.rpm'
  wget 'http://dag.wieers.com/rpm/packages/rrdtool/rrdtool-devel-1.2.18-1.el5.rf.i386.rpm'
  wget 'http://mesh.dl.sourceforge.net/sourceforge/nagiosgraph/nagiosgraph-0.9.0.tgz'
  yum install -y libart_lgpl.i386
  rpm -hiv *rrdtool*.rpm

  tar xzvf nagiosgraph-0.9.0.tgz
  cd nagiosgraph-0.9.0
  mkdir /usr/local/nagios/nagiosgraph
  cp -r . /usr/local/nagios/nagiosgraph/
  mkdir /usr/local/nagios/nagiosgraph/rrd
  chmod go+rX /usr/local/nagios/nagiosgraph
  chown nagios /usr/local/nagios/nagiosgraph/rrd
  mkdir -p /var/spool/nagios
  touch /var/log/nagiosgraph.log /var/spool/nagios/perfdata.log
  chown nagios.apache /var/log/nagiosgraph.log /var/spool/nagios/perfdata.log
  chmod 664 /var/log/nagiosgraph.log
  chmod 644 /var/spool/nagios/perfdata.log

  ln -s /usr/local/nagios/nagiosgraph/nagiosgraph.conf /usr/local/etc/nagiosgraph.conf

  cp nagiosgraph.css /usr/local/nagios/share/stylesheets


Fedora Core 6 and HTTP output parsing
-------------------------------------

The entry in the map file for HTTP does not work for Fedora core 6
with Nagios 2.6 and later.  This is what did work.

	# Service type: unix-www
	#   ouput:OK - HTTP/1.1 302 Found - 0.002 second response time |time=0.001920s;;;0.000000 size=126B;;;0
	/output:.*?HTTP.*?([.0-9]+) sec/
	and push @s, [ http,
		[ rt, GAUGE, $1 ] ];
